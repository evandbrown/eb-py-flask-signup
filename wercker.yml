box: wercker-labs/docker
build:
  steps:
    - docker-image:
        name: Build and package the Docker image
        code: |
          cd $WERCKER_SOURCE_DIR
          sudo docker build -t evandbrown/eb-py-flask .
          CONTAINER_ID=$(sudo docker run -d evandbrown/eb-py-flask)
          sudo docker export $CONTAINER_ID > container.tar
          DATETIME=`date +%s`
          tar -cvzf $WERCKER_OUTPUT_DIR/application-$DATETIME.tgz container.tar Docker.mf
    - eb-package:
        name: Package the Docker image with its manifest
        code: |
          cd $WERCKER_SOURCE_DIR
          sudo docker build -t evandbrown/eb-py-flask .
          CONTAINER_ID=$(sudo docker run -d evandbrown/eb-py-flask)
          sudo docker export $CONTAINER_ID > $WERCKER_OUTPUT_DIR/container.tar
deploy:
  steps:
    - s3sync:
        key-id: $KEY
        key-secret: $SECRET
        bucket-url: $BUCKET
        source-dir: $SOURCE